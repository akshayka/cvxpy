
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Total variation in-painting &#8212; CVXPY 1.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/cvxpy_alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="total-variation-in-painting">
<h1>Total variation in-painting<a class="headerlink" href="#total-variation-in-painting" title="Permalink to this headline">¶</a></h1>
<div class="section" id="grayscale-images">
<h2>Grayscale Images<a class="headerlink" href="#grayscale-images" title="Permalink to this headline">¶</a></h2>
<p>A grayscale image is represented as an <span class="math">\(m \times n\)</span> matrix of
intensities <span class="math">\(U^\mathrm{orig}\)</span> (typically between the values
<span class="math">\(0\)</span> and <span class="math">\(255\)</span>). We are given the values
<span class="math">\(U^\mathrm{orig}_{ij}\)</span>, for <span class="math">\((i,j) \in \mathcal K\)</span>, where
<span class="math">\(\mathcal K \subset \{1,\ldots, m\} \times \{1, \ldots, n\}\)</span> is
the set of indices corresponding to known pixel values. Our job is to
<em>in-paint</em> the image by guessing the missing pixel values, <em>i.e.</em>, those
with indices not in <span class="math">\(\mathcal K\)</span>. The reconstructed image will be
represented by <span class="math">\(U \in {\bf R}^{m \times n}\)</span>, where <span class="math">\(U\)</span>
matches the known pixels, <em>i.e.</em>, <span class="math">\(U_{ij} = U^\mathrm{orig}_{ij}\)</span>
for <span class="math">\((i,j) \in \mathcal K\)</span>.</p>
<p>The reconstruction <span class="math">\(U\)</span> is found by minimizing the total variation
of <span class="math">\(U\)</span>, subject to matching the known pixel values. We will use
the <span class="math">\(\ell_2\)</span> total variation, defined as</p>
<div class="math">
\[\begin{split}\mathop{\bf tv}(U) =
\sum_{i=1}^{m-1} \sum_{j=1}^{n-1}
\left\| \left[ \begin{array}{c}
 U_{i+1,j}-U_{ij}\\ U_{i,j+1}-U_{ij} \end{array} \right] \right\|_2.\end{split}\]</div>
<p>Note that the norm of the discretized gradient is <em>not</em> squared.</p>
<p>We load the original image and the corrupted image and construct the
Known matrix. Both images are displayed below. The corrupted image has
the missing pixels whited out.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Load the images.</span>
<span class="n">orig_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;data/lena512.png&quot;</span><span class="p">)</span>
<span class="n">corr_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;data/lena512_corrupted.png&quot;</span><span class="p">)</span>


<span class="c1"># Convert to arrays.</span>
<span class="n">Uorig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orig_img</span><span class="p">)</span>
<span class="n">Ucorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">corr_img</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span> <span class="n">cols</span> <span class="o">=</span> <span class="n">Uorig</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Known is 1 if the pixel is known,</span>
<span class="c1"># 0 if the pixel was corrupted.</span>
<span class="n">Known</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
         <span class="k">if</span> <span class="n">Uorig</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">==</span> <span class="n">Ucorr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]:</span>
            <span class="n">Known</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">orig_img</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original Image&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corr_img</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Corrupted Image&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/tv_inpainting_2_0.png" src="../../_images/tv_inpainting_2_0.png" />
<p>The total variation in-painting problem can be easily expressed in
CVXPY. We use the solver SCS, which finds the optimal value in a few
seconds. The solvers ECOS and CVXOPT take much longer to solve this
large problem.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Recover the original image using total variation in-painting.</span>
<span class="kn">from</span> <span class="nn">cvxpy</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">U</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
<span class="n">obj</span> <span class="o">=</span> <span class="n">Minimize</span><span class="p">(</span><span class="n">tv</span><span class="p">(</span><span class="n">U</span><span class="p">))</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">multiply</span><span class="p">(</span><span class="n">Known</span><span class="p">,</span> <span class="n">U</span><span class="p">)</span> <span class="o">==</span> <span class="n">multiply</span><span class="p">(</span><span class="n">Known</span><span class="p">,</span> <span class="n">Ucorr</span><span class="p">)]</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
<span class="c1"># Use SCS to solve the problem.</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">SCS</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">----------------------------------------------------------------------------</span>
    <span class="n">SCS</span> <span class="n">v1</span><span class="o">.</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">Splitting</span> <span class="n">Conic</span> <span class="n">Solver</span>
    <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Brendan</span> <span class="n">O</span><span class="s1">&#39;Donoghue, Stanford University, 2012</span>
<span class="o">----------------------------------------------------------------------------</span>
<span class="n">Lin</span><span class="o">-</span><span class="n">sys</span><span class="p">:</span> <span class="n">sparse</span><span class="o">-</span><span class="n">direct</span><span class="p">,</span> <span class="n">nnz</span> <span class="ow">in</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">1547594</span>
<span class="n">EPS</span> <span class="o">=</span> <span class="mf">1.00e-03</span><span class="p">,</span> <span class="n">ALPHA</span> <span class="o">=</span> <span class="mf">1.80</span><span class="p">,</span> <span class="n">MAX_ITERS</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">,</span> <span class="n">NORMALIZE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SCALE</span> <span class="o">=</span> <span class="mf">5.00</span>
<span class="n">Variables</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">523265</span><span class="p">,</span> <span class="n">constraints</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">1045507</span>
<span class="n">Cones</span><span class="p">:</span>      <span class="n">primal</span> <span class="n">zero</span> <span class="o">/</span> <span class="n">dual</span> <span class="n">free</span> <span class="nb">vars</span><span class="p">:</span> <span class="mi">262144</span>
    <span class="n">soc</span> <span class="nb">vars</span><span class="p">:</span> <span class="mi">783363</span><span class="p">,</span> <span class="n">soc</span> <span class="n">blks</span><span class="p">:</span> <span class="mi">261121</span>
<span class="n">Setup</span> <span class="n">time</span><span class="p">:</span> <span class="mf">3.84e+00</span><span class="n">s</span>
<span class="o">----------------------------------------------------------------------------</span>
 <span class="n">Iter</span> <span class="o">|</span> <span class="n">pri</span> <span class="n">res</span> <span class="o">|</span> <span class="n">dua</span> <span class="n">res</span> <span class="o">|</span> <span class="n">rel</span> <span class="n">gap</span> <span class="o">|</span> <span class="n">pri</span> <span class="n">obj</span> <span class="o">|</span> <span class="n">dua</span> <span class="n">obj</span> <span class="o">|</span> <span class="n">kap</span><span class="o">/</span><span class="n">tau</span> <span class="o">|</span> <span class="n">time</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="o">----------------------------------------------------------------------------</span>
     <span class="mi">0</span><span class="o">|</span> <span class="mf">2.97e+00</span>  <span class="mf">5.93e+00</span>  <span class="mf">1.00e+00</span> <span class="o">-</span><span class="mf">2.92e+07</span>  <span class="mf">6.59e+06</span>  <span class="mf">7.18e-09</span>  <span class="mf">2.58e-01</span>
   <span class="mi">100</span><span class="o">|</span> <span class="mf">3.38e-04</span>  <span class="mf">2.47e-03</span>  <span class="mf">3.84e-05</span>  <span class="mf">2.21e+06</span>  <span class="mf">2.21e+06</span>  <span class="mf">6.98e-10</span>  <span class="mf">9.92e+00</span>
   <span class="mi">140</span><span class="o">|</span> <span class="mf">1.01e-04</span>  <span class="mf">7.24e-04</span>  <span class="mf">1.24e-05</span>  <span class="mf">2.21e+06</span>  <span class="mf">2.21e+06</span>  <span class="mf">6.98e-10</span>  <span class="mf">1.36e+01</span>
<span class="o">----------------------------------------------------------------------------</span>
<span class="n">Status</span><span class="p">:</span> <span class="n">Solved</span>
<span class="n">Timing</span><span class="p">:</span> <span class="n">Total</span> <span class="n">solve</span> <span class="n">time</span><span class="p">:</span> <span class="mf">1.37e+01</span><span class="n">s</span>
    <span class="n">Lin</span><span class="o">-</span><span class="n">sys</span><span class="p">:</span> <span class="n">nnz</span> <span class="ow">in</span> <span class="n">L</span> <span class="n">factor</span><span class="p">:</span> <span class="mi">12280804</span><span class="p">,</span> <span class="n">avg</span> <span class="n">solve</span> <span class="n">time</span><span class="p">:</span> <span class="mf">6.61e-02</span><span class="n">s</span>
    <span class="n">Cones</span><span class="p">:</span> <span class="n">avg</span> <span class="n">projection</span> <span class="n">time</span><span class="p">:</span> <span class="mf">4.14e-03</span><span class="n">s</span>
<span class="o">----------------------------------------------------------------------------</span>
<span class="n">Error</span> <span class="n">metrics</span><span class="p">:</span>
<span class="o">|</span><span class="n">Ax</span> <span class="o">+</span> <span class="n">s</span> <span class="o">-</span> <span class="n">b</span><span class="o">|</span><span class="n">_2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">_2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.0084e-04</span>
<span class="o">|</span><span class="n">A</span><span class="s1">&#39;y + c|_2 / (1 + |c|_2) = 7.2392e-04</span>
<span class="o">|</span><span class="n">c</span><span class="s1">&#39;x + b&#39;</span><span class="n">y</span><span class="o">|</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">|</span><span class="n">c</span><span class="s1">&#39;x| + |b&#39;</span><span class="n">y</span><span class="o">|</span><span class="p">)</span> <span class="o">=</span> <span class="mf">1.2426e-05</span>
<span class="n">dist</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">K</span><span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="s1">&#39;y = 0</span>
<span class="o">----------------------------------------------------------------------------</span>
<span class="n">c</span><span class="s1">&#39;x = 2209202.9055, -b&#39;</span><span class="n">y</span> <span class="o">=</span> <span class="mf">2209257.8084</span>
<span class="o">============================================================================</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">2209202.9055004898</span>
</pre></div>
</div>
<p>After solving the problem, the in-painted image is stored in
<code class="docutils literal"><span class="pre">U.value</span></code>. We display the in-painted image and the intensity
difference between the original and in-painted images. The intensity
difference is magnified by a factor of 10 so it is more visible.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1"># Display the in-painted image.</span>
<span class="n">img_rec</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">U</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_rec</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;In-Painted Image&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">img_diff</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Uorig</span> <span class="o">-</span> <span class="n">U</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_diff</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Difference Image&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/tv_inpainting_6_0.png" src="../../_images/tv_inpainting_6_0.png" />
</div>
</div>
<div class="section" id="color-images">
<h1>Color Images<a class="headerlink" href="#color-images" title="Permalink to this headline">¶</a></h1>
<p>For color images, the in-painting problem is similar to the grayscale
case. A color image is represented as an <span class="math">\(m \times n \times 3\)</span>
matrix of RGB values <span class="math">\(U^\mathrm{orig}\)</span> (typically between the
values <span class="math">\(0\)</span> and <span class="math">\(255\)</span>). We are given the pixels
<span class="math">\(U^\mathrm{orig}_{ij}\)</span>, for <span class="math">\((i,j) \in \mathcal K\)</span>, where
<span class="math">\(\mathcal K \subset \{1,\ldots, m\} \times \{1, \ldots, n\}\)</span> is
the set of indices corresponding to known pixels. Each pixel
<span class="math">\(U^\mathrm{orig}_{ij}\)</span> is a vector in <span class="math">\({\bf R}^3\)</span> of RGB
values. Our job is to <em>in-paint</em> the image by guessing the missing
pixels, <em>i.e.</em>, those with indices not in <span class="math">\(\mathcal K\)</span>. The
reconstructed image will be represented by
<span class="math">\(U \in {\bf R}^{m \times n \times 3}\)</span>, where <span class="math">\(U\)</span> matches the
known pixels, <em>i.e.</em>, <span class="math">\(U_{ij} = U^\mathrm{orig}_{ij}\)</span> for
<span class="math">\((i,j) \in \mathcal K\)</span>.</p>
<p>The reconstruction <span class="math">\(U\)</span> is found by minimizing the total variation
of <span class="math">\(U\)</span>, subject to matching the known pixel values. We will use
the <span class="math">\(\ell_2\)</span> total variation, defined as</p>
<div class="math">
\[\begin{split}\mathop{\bf tv}(U) =
\sum_{i=1}^{m-1} \sum_{j=1}^{n-1}
\left\| \left[ \begin{array}{c}
 U_{i+1,j}-U_{ij}\\
 U_{i,j+1}-U_{ij}
 \end{array} \right] \right\|_2.\end{split}\]</div>
<p>Note that the norm of the discretized gradient is <em>not</em> squared.</p>
<p>We load the original image and construct the Known matrix by randomly
selecting 30% of the pixels to keep and discarding the others. The
original and corrupted images are displayed below. The corrupted image
has the missing pixels blacked out.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="k">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># Load the images.</span>
<span class="n">orig_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;data/lena512color.tiff&quot;</span><span class="p">)</span>

<span class="c1"># Convert to arrays.</span>
<span class="n">Uorig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">orig_img</span><span class="p">)</span>
<span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">colors</span> <span class="o">=</span> <span class="n">Uorig</span><span class="o">.</span><span class="n">shape</span>

<span class="c1"># Known is 1 if the pixel is known,</span>
<span class="c1"># 0 if the pixel was corrupted.</span>
<span class="c1"># The Known matrix is initialized randomly.</span>
<span class="n">Known</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">colors</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">cols</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">colors</span><span class="p">):</span>
                <span class="n">Known</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">Ucorr</span> <span class="o">=</span> <span class="n">Known</span><span class="o">*</span><span class="n">Uorig</span>
<span class="n">corr_img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">Ucorr</span><span class="p">))</span>

<span class="c1"># Display the images.</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">orig_img</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original Image&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">corr_img</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Corrupted Image&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/tv_inpainting_9_0.png" src="../../_images/tv_inpainting_9_0.png" />
<p>We express the total variation color in-painting problem in CVXPY using
three matrix variables (one for the red values, one for the blue values,
and one for the green values). We use the solver SCS, which finds the
optimal value in 25 seconds. The solvers ECOS and CVXOPT don’t scale to
this large problem.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="c1"># Recover the original image using total variation in-painting.</span>
<span class="kn">from</span> <span class="nn">cvxpy</span> <span class="k">import</span> <span class="o">*</span>
<span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">colors</span><span class="p">):</span>
    <span class="n">U</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">))</span>
    <span class="n">variables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">U</span><span class="p">)</span>
    <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multiply</span><span class="p">(</span><span class="n">Known</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">U</span><span class="p">)</span> <span class="o">==</span> <span class="n">multiply</span><span class="p">(</span><span class="n">Known</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">Ucorr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]))</span>

<span class="n">prob</span> <span class="o">=</span> <span class="n">Problem</span><span class="p">(</span><span class="n">Minimize</span><span class="p">(</span><span class="n">tv</span><span class="p">(</span><span class="o">*</span><span class="n">variables</span><span class="p">)),</span> <span class="n">constraints</span><span class="p">)</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">SCS</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="o">----------------------------------------------------------------------------</span>
    <span class="n">SCS</span> <span class="n">v1</span><span class="o">.</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">Splitting</span> <span class="n">Conic</span> <span class="n">Solver</span>
    <span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="n">Brendan</span> <span class="n">O</span><span class="s1">&#39;Donoghue, Stanford University, 2012</span>
<span class="o">----------------------------------------------------------------------------</span>
<span class="n">Lin</span><span class="o">-</span><span class="n">sys</span><span class="p">:</span> <span class="n">sparse</span><span class="o">-</span><span class="n">direct</span><span class="p">,</span> <span class="n">nnz</span> <span class="ow">in</span> <span class="n">A</span> <span class="o">=</span> <span class="mi">3630814</span>
<span class="n">EPS</span> <span class="o">=</span> <span class="mf">1.00e-03</span><span class="p">,</span> <span class="n">ALPHA</span> <span class="o">=</span> <span class="mf">1.80</span><span class="p">,</span> <span class="n">MAX_ITERS</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">,</span> <span class="n">NORMALIZE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SCALE</span> <span class="o">=</span> <span class="mf">5.00</span>
<span class="n">Variables</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">1047553</span><span class="p">,</span> <span class="n">constraints</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">2614279</span>
<span class="n">Cones</span><span class="p">:</span>      <span class="n">primal</span> <span class="n">zero</span> <span class="o">/</span> <span class="n">dual</span> <span class="n">free</span> <span class="nb">vars</span><span class="p">:</span> <span class="mi">786432</span>
    <span class="n">soc</span> <span class="nb">vars</span><span class="p">:</span> <span class="mi">1827847</span><span class="p">,</span> <span class="n">soc</span> <span class="n">blks</span><span class="p">:</span> <span class="mi">261121</span>
<span class="n">Setup</span> <span class="n">time</span><span class="p">:</span> <span class="mf">1.16e+01</span><span class="n">s</span>
<span class="o">----------------------------------------------------------------------------</span>
 <span class="n">Iter</span> <span class="o">|</span> <span class="n">pri</span> <span class="n">res</span> <span class="o">|</span> <span class="n">dua</span> <span class="n">res</span> <span class="o">|</span> <span class="n">rel</span> <span class="n">gap</span> <span class="o">|</span> <span class="n">pri</span> <span class="n">obj</span> <span class="o">|</span> <span class="n">dua</span> <span class="n">obj</span> <span class="o">|</span> <span class="n">kap</span><span class="o">/</span><span class="n">tau</span> <span class="o">|</span> <span class="n">time</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="o">----------------------------------------------------------------------------</span>
     <span class="mi">0</span><span class="o">|</span> <span class="mf">4.87e+00</span>  <span class="mf">2.03e+01</span>       <span class="n">nan</span>      <span class="o">-</span><span class="n">inf</span>       <span class="n">inf</span>       <span class="n">inf</span>  <span class="mf">6.55e-01</span>
   <span class="mi">100</span><span class="o">|</span> <span class="mf">7.28e-05</span>  <span class="mf">4.92e-04</span>  <span class="mf">5.96e-06</span>  <span class="mf">2.91e+06</span>  <span class="mf">2.91e+06</span>  <span class="mf">7.28e-10</span>  <span class="mf">3.22e+01</span>
<span class="o">----------------------------------------------------------------------------</span>
<span class="n">Status</span><span class="p">:</span> <span class="n">Solved</span>
<span class="n">Timing</span><span class="p">:</span> <span class="n">Total</span> <span class="n">solve</span> <span class="n">time</span><span class="p">:</span> <span class="mf">3.24e+01</span><span class="n">s</span>
    <span class="n">Lin</span><span class="o">-</span><span class="n">sys</span><span class="p">:</span> <span class="n">nnz</span> <span class="ow">in</span> <span class="n">L</span> <span class="n">factor</span><span class="p">:</span> <span class="mi">35251632</span><span class="p">,</span> <span class="n">avg</span> <span class="n">solve</span> <span class="n">time</span><span class="p">:</span> <span class="mf">2.35e-01</span><span class="n">s</span>
    <span class="n">Cones</span><span class="p">:</span> <span class="n">avg</span> <span class="n">projection</span> <span class="n">time</span><span class="p">:</span> <span class="mf">7.62e-03</span><span class="n">s</span>
<span class="o">----------------------------------------------------------------------------</span>
<span class="n">Error</span> <span class="n">metrics</span><span class="p">:</span>
<span class="o">|</span><span class="n">Ax</span> <span class="o">+</span> <span class="n">s</span> <span class="o">-</span> <span class="n">b</span><span class="o">|</span><span class="n">_2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">_2</span><span class="p">)</span> <span class="o">=</span> <span class="mf">7.2806e-05</span>
<span class="o">|</span><span class="n">A</span><span class="s1">&#39;y + c|_2 / (1 + |c|_2) = 4.9207e-04</span>
<span class="o">|</span><span class="n">c</span><span class="s1">&#39;x + b&#39;</span><span class="n">y</span><span class="o">|</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="o">|</span><span class="n">c</span><span class="s1">&#39;x| + |b&#39;</span><span class="n">y</span><span class="o">|</span><span class="p">)</span> <span class="o">=</span> <span class="mf">5.9594e-06</span>
<span class="n">dist</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dist</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">K</span><span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="s1">&#39;y = 0</span>
<span class="o">----------------------------------------------------------------------------</span>
<span class="n">c</span><span class="s1">&#39;x = 2906748.2457, -b&#39;</span><span class="n">y</span> <span class="o">=</span> <span class="mf">2906782.8906</span>
<span class="o">============================================================================</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="mf">2906748.2456711144</span>
</pre></div>
</div>
<p>After solving the problem, the RGB values of the in-painted image are
stored in the value fields of the three variables. We display the
in-painted image and the difference in RGB values at each pixel of the
original and in-painted image. Though the in-painted image looks almost
identical to the original image, you can see that many of the RGB values
differ.</p>
<div class="code highlight-default"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.cm</span> <span class="k">as</span> <span class="nn">cm</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>

<span class="c1"># Load variable values into a single array.</span>
<span class="n">rec_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">rows</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="n">colors</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">colors</span><span class="p">):</span>
    <span class="n">rec_arr</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1"># Display the in-painted image.</span>
<span class="n">img_rec</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">rec_arr</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_rec</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;In-Painted Image&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="n">img_diff</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Uorig</span> <span class="o">-</span> <span class="n">rec_arr</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img_diff</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Difference Image&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="../../_images/tv_inpainting_13_0.png" src="../../_images/tv_inpainting_13_0.png" />
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">CVXPY</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=cvxgrp&repo=cvxpy&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a href="https://travis-ci.org/cvxgrp/cvxpy">
    <img
        alt="https://secure.travis-ci.org/cvxgrp/cvxpy.svg?branch=master"
        src="https://secure.travis-ci.org/cvxgrp/cvxpy.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html">Install Guide</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial/index.html">Tutorial</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">Examples</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference/cvxpy.html">API Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">FAQ</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../citing/index.html">Citing CVXPY</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../updates/index.html">What’s New in CVXPY 1.0</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../related_projects/index.html">Related Projects</a></li>
</ul>


<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Steven Diamond, Eric Chu, Akshay Agrawal, Stephen Boyd.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../../_sources/examples/applications/tv_inpainting.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/cvxgrp/cvxpy" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-50248335-1']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>